name: Bump Gitjob Chart in Fleet

scms:
  fleet:
    kind: github
    spec:
      user: fleet-bot
      email: fleet@olblak.com
      owner: olblak
      repository: fleet
      token: '{{ requiredEnv "UPDATECLI_GITHUB_TOKEN" }}'
      username: '{{ requiredEnv "UPDATECLI_GITHUB_ACTOR" }}'
      branch: test_update_gitjob_with_updatecli

sources:
  gitjobversion:
    name: Get latest Gitjob version
    kind: githubrelease
    spec:
      owner: rancher
      repository: gitjob
      token: '{{ requiredEnv "UPDATECLI_GITHUB_TOKEN" }}'
      username: '{{ requiredEnv "UPDATECLI_GITHUB_ACTOR" }}'
      versionfilter:
        kind: semver
        pattern: "~0.1.30"
    # The assets name do not contains the 'v' prefix before the version
    transformers:
      - trimprefix: v

targets:
  gitjob:
    kind: shell
    name: "Update Gitjob chart to latest version"
    scmid: fleet
    sourceid: gitjobversion
    spec:
      # gitjob source value is automatically added to the command as a parameter
      command: "./updatecli/scripts/integrate_gitjob_release.sh"
      environments:
        - name: PATH

actions:
  default:
    title: '[updatecli] Bump Gitjob chart to {{ source "gitjobversion" }}'
    kind: github/pullrequest
    scmid: fleet
    spec:
      automerge: false
      mergemethod: squash
      labels:
        - dependencies

